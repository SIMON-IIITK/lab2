name: ML Training Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  train-and-report:
    runs-on: ubuntu-latest

    steps:
    # 1. Get the code
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Install Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. Install Libraries
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 4. Run the Training Script
    - name: Run Training Script
      run: python train.py

    # 5. Create Job Summary
    - name: Generate Job Summary
      run: |
        echo "## ML Experiment Results" >> $GITHUB_STEP_SUMMARY
        echo "### Student: Your Name (Roll No: 123456)" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        
        # Extract values from JSON for the table
        MSE=$(python -c "import json; print(json.load(open('output/metrics.json'))['mse'])")
        R2=$(python -c "import json; print(json.load(open('output/metrics.json'))['r2_score'])")
        MODEL=$(python -c "import json; print(json.load(open('output/metrics.json'))['model_type'])")
        
        echo "| **Model** | $MODEL |" >> $GITHUB_STEP_SUMMARY
        echo "| **MSE** | $MSE |" >> $GITHUB_STEP_SUMMARY
        echo "| **RÂ² Score** | $R2 |" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Full Configuration" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
        cat output/metrics.json >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    # 6. Save Artifacts (Model and JSON)
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: experiment-results
        path: output/